{% extends 'base.html' %}
{% load static %}

{% block title %}Payment #{{ payment.id }} - UH Care{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8">
    
    <h1 class="text-3xl font-bold text-uh-blue-700 mb-8">Payment Details</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Main Content -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Payment Details Card -->
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <!-- Icon and Title -->
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-uh-blue-100 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-uh-blue-700">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6m3-3.75l3 3m0 0l3-3m-3 3v-6m-1.5 9H5.625c-.621 0-1.125-.504-1.125-1.125V18.25M6.75 7.5l3-3m0 0l3 3m-3-3v11.25m6-11.25h.008v.008H12.75V7.5z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-uh-blue-700">Payment #{{ payment.id }}</h2>
                        </div>
                        
                        <!-- Amount and Status -->
                        <div class="text-left sm:text-right">
                            <div class="text-3xl font-bold text-uh-green-600">रू {{ payment.amount }}</div>
                            <div class="mt-1">
                                {% if payment.payment_status == 'paid' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-uh-green-100 text-uh-green-600">
                                        Paid
                                    </span>
                                {% elif payment.payment_status == 'pending' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700">
                                        Pending Verification
                                    </span>
                                {% elif payment.payment_status == 'unpaid' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-uh-red-100 text-uh-red-600">
                                        Unpaid
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
                                        {{ payment.get_payment_status_display|default:payment.payment_status }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 border-t border-gray-200 pt-6 space-y-4">
                        {% if payment.payment_status == 'pending' %}
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-md">
                                <p class="font-medium">Payment proof submitted and awaiting verification. Our team will update the status shortly.</p>
                                {% if payment.payment_proof_file or payment.payment_proof_url %}
                                    <div class="mt-2">
                                        <strong>Submitted proof:</strong>
                                        {% if payment.payment_proof_file %}
                                            <a href="{{ payment.payment_proof_file.url }}" target="_blank" class="ml-2 font-medium text-uh-blue-700 hover:underline">View uploaded file</a>
                                        {% elif payment.payment_proof_url %}
                                            <a href="{{ payment.payment_proof_url }}" target="_blank" class="ml-2 font-medium text-uh-blue-700 hover:underline">View proof URL</a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <p class="text-gray-700"><strong class="font-medium text-gray-900">Method:</strong> {{ payment.get_payment_method_display|default:payment.payment_method }}</p>
                        <p class="text-sm text-gray-500"><strong class="font-medium text-gray-900">Created:</strong> {{ payment.created_at|date:'F d, Y H:i' }}</p>
                    </div>
                </div>
            </div>

            <!-- Change Payment Method Card -->
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800">Choose or change payment method</h3>
                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <!-- The 'form-radio' class is styled by the @tailwindcss/forms plugin -->
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border border-gray-300 rounded-lg hover:border-uh-blue-600 {% if payment.payment_method %}cursor-default{% else %}cursor-pointer{% endif %}">
                                <input type="radio" name="payment_method" value="online" class="form-radio h-5 w-5 text-uh-blue-700 focus:ring-uh-blue-600" {% if payment.payment_method == 'online' %}checked{% endif %} {% if payment.payment_method %}disabled{% endif %}>
                                <span class="ml-3 text-sm font-medium text-gray-700">Online payment (QR / Upload proof)</span>
                            </label>
                            <label class="flex items-center p-4 border border-gray-300 rounded-lg hover:border-uh-blue-600 {% if payment.payment_method %}cursor-default{% else %}cursor-pointer{% endif %}">
                                <input type="radio" name="payment_method" value="cash" class="form-radio h-5 w-5 text-uh-blue-700 focus:ring-uh-blue-600" {% if payment.payment_method == 'cash' %}checked{% endif %} {% if payment.payment_method %}disabled{% endif %}>
                                <span class="ml-3 text-sm font-medium text-gray-700">Cash after service</span>
                            </label>
                        </div>

                        <div class="mt-6 flex flex-col sm:flex-row items-center gap-4">
                            {% if not payment.payment_method %}
                            <button class="w-full sm:w-auto bg-uh-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-blue-600 focus:outline-none focus:ring-2 focus:ring-uh-blue-700 focus:ring-offset-2 transition-all duration-200" type="submit">
                                Save Method
                            </button>
                            {% else %}
                            <div class="w-full sm:w-auto bg-gray-50 border border-gray-200 text-sm text-gray-700 p-3 rounded-md">Payment method is locked to <strong>{{ payment.get_payment_method_display|default:payment.payment_method }}</strong> and cannot be changed.</div>
                            {% endif %}
                            <a class="w-full sm:w-auto text-center font-semibold text-gray-700 bg-white border border-gray-300 py-2.5 px-6 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200" 
                               href="{% url 'dashboard:patient_balance' %}">
                                Back to balance
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Conditional Action Buttons -->
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Payment Actions</h3>
                    
                    {% if payment.payment_method == 'online' %}
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <a class="w-full sm:w-auto text-center bg-uh-green-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-green-500 focus:outline-none focus:ring-2 focus:ring-uh-green-600 focus:ring-offset-2 transition-all duration-200" 
                           href="{% url 'payments:qr_code' payment.id %}">
                            Proceed to online payment (QR)
                        </a>
                        <a class="w-full sm:w-auto text-center font-semibold text-gray-700 bg-white border border-gray-300 py-2.5 px-6 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200" 
                           href="{% url 'payments:upload_proof' payment.id %}">
                            I have paid (Upload proof)
                        </a>
                    </div>
                    {% endif %}

                    {% if payment.payment_method == 'cash' %}
                    <div class="space-y-4">
                        {% if appointment %}
                            {% if appointment.status == 'completed' %}
                                <a class="w-full sm:w-auto text-center bg-uh-green-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-green-500 focus:outline-none focus:ring-2 focus:ring-uh-green-600 focus:ring-offset-2 transition-all duration-200" 
                                   href="{% url 'payments:confirm' payment.id %}">
                                    Confirm payment (I paid)
                                </a>
                            {% else %}
                                <div class="bg-gray-100 text-gray-700 p-4 rounded-lg text-sm">Cash after service selected. You can confirm payment after the appointment is completed.</div>
                            {% endif %}
                        {% elif payment.pharmacy_order %}
                            {% if payment.pharmacy_order.status == 'delivered' %}
                                <a class="w-full sm:w-auto text-center bg-uh-green-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-green-500 focus:outline-none focus:ring-2 focus:ring-uh-green-600 focus:ring-offset-2 transition-all duration-200" 
                                   href="{% url 'payments:confirm' payment.id %}">
                                    Confirm payment (I paid on delivery)
                                </a>
                            {% else %}
                                <div class="bg-gray-100 text-gray-700 p-4 rounded-lg text-sm">Cash on delivery selected for this pharmacy order. Confirm payment once your order is delivered.</div>
                            {% endif %}
                        {% elif payment.equipment_purchase %}
                            {% if payment.equipment_purchase.status == 'delivered' %}
                                <a class="w-full sm:w-auto text-center bg-uh-green-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-green-500 focus:outline-none focus:ring-2 focus:ring-uh-green-600 focus:ring-offset-2 transition-all duration-200" 
                                   href="{% url 'payments:confirm' payment.id %}">
                                    Confirm payment (I paid on delivery)
                                </a>
                            {% else %}
                                <div class="bg-gray-100 text-gray-700 p-4 rounded-lg text-sm">Cash on delivery selected for this purchase. Confirm payment once the item is delivered.</div>
                            {% endif %}
                        {% elif payment.equipment_rental %}
                            {% if payment.equipment_rental.status == 'returned' or payment.equipment_rental.status == 'active' %}
                                <a class="w-full sm:w-auto text-center bg-uh-green-600 text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:bg-uh-green-500 focus:outline-none focus:ring-2 focus:ring-uh-green-600 focus:ring-offset-2 transition-all duration-200" 
                                   href="{% url 'payments:confirm' payment.id %}">
                                    Confirm payment (I paid)
                                </a>
                            {% else %}
                                <div class="bg-gray-100 text-gray-700 p-4 rounded-lg text-sm">Cash selected for this rental. Confirm payment once rental is delivered/returned.</div>
                            {% endif %}
                        {% else %}
                            <div class="bg-gray-100 text-gray-700 p-4 rounded-lg text-sm">Cash selected. You can confirm payment after service/delivery.</div>
                        {% endif %}
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>

        <!-- Right Column: Linked Item Sidebar -->
        <aside class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-xl p-6 sticky top-24">
                
                {% if appointment %}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-uh-blue-100 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-uh-blue-700">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Linked Appointment</h3>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong class="text-gray-900">Service:</strong> {{ appointment.service.name }}</p>
                    <p><strong class="text-gray-900">Provider:</strong> {{ appointment.provider.get_full_name }}</p>
                    <p><strong class="text-gray-900">Scheduled:</strong> {{ appointment.scheduled_at|date:'F d, Y H:i' }}</p>
                </div>
                
                {% elif payment.pharmacy_order %}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-uh-blue-100 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-uh-blue-700">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Linked Pharmacy Order</h3>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong class="text-gray-900">Order #:</strong> {{ payment.pharmacy_order.order_number }}</p>
                    <p><strong class="text-gray-900">Items:</strong> {{ payment.pharmacy_order.items.count }} item(s)</p>
                    <p><strong class="text-gray-900">Total:</strong> रू {{ payment.pharmacy_order.total_amount }}</p>
                    <a href="{% url 'pharmacy:order_confirmation' payment.pharmacy_order.order_number %}" class="inline-block mt-2 font-medium text-uh-blue-700 hover:text-uh-blue-600">View order →</a>
                </div>
                
                {% elif payment.equipment_purchase %}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-uh-blue-100 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-uh-blue-700">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192a48.424 48.424 0 011.621-.056A48.424 48.424 0 0112 3.86m0 0a48.424 48.424 0 015.103.056c1.13.094 1.976 1.057 1.976 2.192V7.5M8.25 7.5h7.5M8.25 7.5V15c0 .621.504 1.125 1.125 1.125h.375c.621 0 1.125-.504 1.125-1.125V7.5m-3 0V15c0 .621.504 1.125 1.125 1.125h.375c.621 0 1.125-.504 1.125-1.125V7.5m-3 0V15c0 .621.504 1.125 1.125 1.125h.375c.621 0 1.125-.504 1.125-1.125V7.5" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Linked Equipment Purchase</h3>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong class="text-gray-900">Order #:</strong> {{ payment.equipment_purchase.order_number }}</p>
                    <p><strong class="text-gray-900">Item:</strong> {{ payment.equipment_purchase.equipment.name }}</p>
                    <p><strong class="text-gray-900">Total:</strong> रू {{ payment.equipment_purchase.total_amount }}</p>
                    <a href="{% url 'equipment:purchase_detail' payment.equipment_purchase.order_number %}" class="inline-block mt-2 font-medium text-uh-blue-700 hover:text-uh-blue-600">View purchase →</a>
                </div>
                
                {% elif payment.equipment_rental %}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-uh-blue-100 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-uh-blue-700">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.992 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-4.992h-4.992m0 0v-4.992m0 4.992l-3.181-3.183a8.25 8.25 0 0111.664 0l3.181 3.183" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">Linked Equipment Rental</h3>
                </div>
                <div class="space-y-2 text-sm">
                    <p><strong class="text-gray-900">Rental #:</strong> {{ payment.equipment_rental.rental_number }}</p>
                    <p><strong class="text-gray-900">Item:</strong> {{ payment.equipment_rental.equipment.name }}</p>
                    <p><strong class="text-gray-900">Total:</strong> रू {{ payment.equipment_rental.total_amount }}</p>
                    <a href="{% url 'equipment:rental_detail' payment.equipment_rental.rental_number %}" class="inline-block mt-2 font-medium text-uh-blue-700 hover:text-uh-blue-600">View rental →</a>
                </div>
                
                {% else %}
                <div class="flex items-center gap-3 mb-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800">No Linked Item</h3>
                </div>
                <p class="text-sm text-gray-600">This payment is not linked to a specific service or order.</p>
                {% endif %}
            </div>
        </aside>

    </div>
</div>
{% endblock %}