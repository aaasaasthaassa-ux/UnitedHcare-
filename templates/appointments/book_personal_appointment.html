{% extends 'base.html' %}
{% load static %}

{% block title %}Book appointment with {{ provider.get_full_name }}{% endblock %}

{% block content %}
<div class="container max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8" data-provider-id="{{ provider.id }}">
    <!-- Professional two-column layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Provider Details Card -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden p-6 sm:p-8">
                <div class_="flex flex-col items-center text-center">
                    <!-- Provider Profile Image -->
                    <div class="mx-auto mb-4 w-24 h-24 rounded-full bg-uh-blue-100 flex items-center justify-center text-4xl font-bold text-uh-blue-700 overflow-hidden">
                        {% if provider.profile_image %}
                            <img src="{{ provider.profile_image.url }}" alt="{{ provider.get_full_name }}" class="w-full h-full object-cover" />
                        {% else %}
                            <!-- Fallback to initials -->
                            {{ provider.first_name.0|upper }}{{ provider.last_name.0|upper }}
                        {% endif %}
                    </div>
                    
                    <!-- Provider Info -->
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-uh-blue-700">{{ provider.get_full_name }}</h2>
                        <p class="text-base text-gray-600 mt-1">{{ provider.provider_profile.get_specialization_display }}</p>
                        <div class="mt-3 text-xl font-semibold text-uh-green-600">
                            Hourly rate: NPR {{ provider.provider_profile.hourly_rate|floatformat:2 }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Booking Form Card -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                <form method="post" id="booking-form">
                    {% csrf_token %}
                    
                    <!-- Form Header -->
                    <h2 class="text-2xl font-bold text-uh-blue-700 mb-0 p-6 sm:p-8 border-b border-gray-200">Book Your Slot</h2>

                    <!-- Form Body -->
                    <div class="p-6 sm:p-8">
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                        {% endif %}
                        
                        {# Hidden server-only fields. #}
                        <div style="display:none;">
                            {{ form.additional_charges }}
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Choose a date</label>
                            <div id="available-dates" class="flex flex-wrap gap-2">
                                {% if available_dates %}
                                    {% for d in available_dates %}
                                        <button type="button" class="btn btn-outline-secondary date-btn" data-date="{{ d|date:'Y-m-d' }}">{{ d|date:'D, M j' }}</button>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-muted p-2">No available dates in the next 30 days.</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Available time slots</label>
                            <div id="slots-container" class="flex flex-wrap gap-2">
                                <div class="text-muted">Select a date to view available time slots.</div>
                            </div>
                        </div>

                        <div class="mb-6 border-t border-b border-gray-200 py-4">
                            <label class="form-label">Selected slot</label>
                            <div id="selected-slot" class="text-muted">No slot selected</div>
                        </div>

                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-4">If you don't see a suitable slot, you can manually request a date and time below.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="form-label" for="{{ form.appointment_date.id_for_label }}">Preferred date (or chosen from above)</label>
                                    {{ form.appointment_date }}
                                    {% if form.appointment_date.errors %}
                                        <div class="text-danger small">{{ form.appointment_date.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                                <div>
                                    <label class="form-label" for="{{ form.appointment_time.id_for_label }}">Preferred time</label>
                                    {{ form.appointment_time }}
                                    {% if form.appointment_time.errors %}
                                        <div class="text-danger small">{{ form.appointment_time.errors|striptags }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="form-label" for="{{ form.appointment_type.id_for_label }}">Appointment type</label>
                                {{ form.appointment_type }}
                                {% if form.appointment_type.errors %}
                                    <div class="text-danger small">{{ form.appointment_type.errors|striptags }}</div>
                                {% endif %}
                            </div>
                            <div>
                                <label class="form-label" for="{{ form.duration_minutes.id_for_label }}">Duration (minutes)</label>
                                {{ form.duration_minutes }}
                                {% if form.duration_minutes.errors %}
                                    <div class="text-danger small">{{ form.duration_minutes.errors|striptags }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="{{ form.consultation_fee.id_for_label }}">Consultation fee (NPR)</label>
                            {{ form.consultation_fee }}
                            <input type="hidden" name="consultation_fee" value="{% if provider.provider_profile.hourly_rate %}{{ provider.provider_profile.hourly_rate }}{% else %}{{ form.initial.consultation_fee }}{% endif %}" />
                            {% if form.consultation_fee.errors %}
                                <div class="text-danger small">{{ form.consultation_fee.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Location</label>
                            <div class="flex flex-wrap gap-4">
                                {{ form.location_type }}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="{{ form.location_address.id_for_label }}">Address (if applicable)</label>
                            {{ form.location_address }}
                            {% if form.location_address.errors %}
                                <div class="text-danger small">{{ form.location_address.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="{{ form.video_link.id_for_label }}">Video link (for remote consult)</label>
                            {{ form.video_link }}
                            {% if form.video_link.errors %}
                                <div class="text-danger small">{{ form.video_link.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="{{ form.symptoms.id_for_label }}">Symptoms / Notes for provider</label>
                            {{ form.symptoms }}
                            {% if form.symptoms.errors %}
                                <div class="text-danger small">{{ form.symptoms.errors|striptags }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label" for="{{ form.reason.id_for_label }}">Reason for appointment</label>
                            {{ form.reason }}
                            {% if form.reason.errors %}
                                <div class="text-danger small">{{ form.reason.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Professional Error Message Box (replaces alert) -->
                        <div id="booking-error" class="alert alert-danger" style="display: none;"></div>

                    </div>

                    <!-- Form Footer with Buttons -->
                    <div class="bg-gray-50 px-6 sm:px-8 py-5 border-t border-gray-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                        <button type="submit" class="w-full sm:w-auto bg-uh-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-uh-blue-600 focus:outline-none focus:ring-2 focus:ring-uh-blue-700 focus:ring-offset-2 transition-all duration-200">
                            Request appointment
                        </button>
                        <a href="{% url 'appointments:provider_directory' %}" class="w-full sm:w-auto text-center font-medium text-gray-700 bg-white border border-gray-300 py-3 px-6 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200">
                            Back to providers
                        </a>
                    </div>
                </form>
            </div>
        </div>

    </div> <!-- End grid -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function(){
    const providerId = document.querySelector('.container').dataset.providerId;
    const slotsContainer = document.getElementById('slots-container');
    const dateButtons = document.querySelectorAll('.date-btn');
    const bookingForm = document.getElementById('booking-form');
    const appointmentTimeInput = document.querySelector('input[name="appointment_time"]');
    const appointmentDateInput = document.querySelector('input[name="appointment_date"]');
    
    // Get the new error message div
    const bookingError = document.getElementById('booking-error');

        function clearSlots(){
            if (slotsContainer) slotsContainer.innerHTML = '';
        }

        function showMessage(msg){
            if (slotsContainer) slotsContainer.innerHTML = '<div class="text-muted">'+msg+'</div>';
        }

        async function fetchSlots(date){
            showMessage('Loading...');
            try{
                const resp = await fetch(`/appointments/provider/${providerId}/slots/${date}/`);
                if(!resp.ok) throw new Error('Network error');
                const data = await resp.json();
                renderSlots(data.slots);
            }catch(err){
                showMessage('Unable to load slots.');
                console.error(err);
            }
        }

        function renderSlots(slots){
            if(!slots || slots.length === 0){
                showMessage('No available slots for this date.');
                return;
            }
            const frag = document.createDocumentFragment();
            slots.forEach(s => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline-primary slot-btn'; // Styled by CSS
                btn.textContent = s.display;
                btn.dataset.time = s.time;
                btn.addEventListener('click', function(){
                    // clear previous selection
                    document.querySelectorAll('.slot-btn.selected').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // set the form time field and update the selected-slot display
                    if(appointmentTimeInput) appointmentTimeInput.value = this.dataset.time;
                    const sel = document.getElementById('selected-slot');
                    if(sel) {
                        sel.textContent = this.textContent;
                        sel.classList.remove('text-muted');
                    }
                    
                    // Hide error message on successful selection
                    if (bookingError) bookingError.style.display = 'none';
                });
                frag.appendChild(btn);
            });
            clearSlots();
            if (slotsContainer) slotsContainer.appendChild(frag);
        }

        dateButtons.forEach(btn => {
            btn.addEventListener('click', function(){
                // highlight selected date
                dateButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const date = this.dataset.date;
                
                // set the appointment_date field on the form
                const dateInput = document.querySelector('input[name="appointment_date"]');
                if(dateInput) dateInput.value = date;
                
                fetchSlots(date);
            });
        });

        // *** MODIFIED SUBMIT LISTENER ***
        // prevent submit if no slot selected, using the error div instead of alert()
        if (bookingForm) bookingForm.addEventListener('submit', function(e){
            if(!appointmentTimeInput || !appointmentTimeInput.value){
                e.preventDefault();
                if(bookingError) {
                    bookingError.textContent = 'Please select a time slot before submitting, or manually enter a time.';
                    bookingError.style.display = 'block';
                }
            } else {
                if(bookingError) bookingError.style.display = 'none';
            }
        });
    })();
</script>
{% endblock %}