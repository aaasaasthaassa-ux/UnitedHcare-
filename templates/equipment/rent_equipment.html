{% extends 'base.html' %}
{% load static %}

{% block title %}Rent {{ equipment.name }} - UH Care{% endblock %}

{% block extra_css %}
<style>
    /* Local styles for equipment rental page (kept minimal; base.html loads Tailwind) */
    body { font-family: 'Inter', sans-serif; }
    /* Style all form inputs rendered by Django */
    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="date"],
    form input[type="tel"],
    form input[type="number"],
    form select,
    form textarea {
        width:100%; padding:.5rem 1rem; border:1px solid #d1d5db; border-radius:.5rem; box-shadow:0 1px 2px rgba(0,0,0,0.05);
    }
    form label { display:block; margin-bottom:.5rem; font-size:.875rem; font-weight:500; color:#374151; }
    .helptext { font-size:.75rem; color:#6b7280; margin-top:.25rem; display:block; }
    .errorlist, .text-danger { font-size:.875rem; color:#b91c1c; list-style:none; padding:0; margin-top:.25rem; }
    .alert { padding:.75rem 1rem; margin-bottom:1rem; border-radius:.5rem; }
    .alert-danger, .alert.error { background-color:#fbe9e9; color:#D32F2F; }
    .btn { display:inline-block; font-weight:600; padding:.5rem .75rem; border-radius:.5rem; }
    .btn-primary { background:#004a9e; color:#fff; }
    .btn-link { font-weight:600; color:#004a9e; }

    /* Minimal adjustments for the summary sidebar */
    .summary-value { font-weight:700; color: #0f766e; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 sm:py-12 px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold text-uh-blue-700 mb-8">Rent: {{ equipment.name }}</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">

        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Equipment Info Card -->
            <div class="bg-white rounded-lg shadow-xl p-6 flex flex-col sm:flex-row gap-6">
                <div class="flex-shrink-0 w-full sm:w-48 h-48 rounded-lg bg-gray-100 flex items-center justify-center overflow-hidden">
                    {% if equipment.image %}
                        <img src="{{ equipment.image.url }}" alt="{{ equipment.name }}" class="w-full h-full object-cover" />
                    {% elif equipment.image_url %}
                        <img src="{{ equipment.image_url }}" alt="{{ equipment.name }}" class="w-full h-full object-cover" />
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-20 h-20 text-gray-400">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 01-2.25 2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 013 12V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25V12zM12 12.75V18m0 0l-3-3m3 3l3-3m-3-6h.008v.008H12V6.75z" />
                        </svg>
                    {% endif %}
                </div>
                    <h2 class="text-2xl font-semibold text-gray-900">{{ equipment.name }}</h2>
                    <p class="text-gray-600 mt-2">{{ equipment.description }}</p>
                    <div class="text-2xl font-bold text-uh-green-600 mt-3">
                        रू {{ equipment.price_per_day|floatformat:2 }} <span class="text-base font-normal text-gray-600">/ day</span>
                    </div>
                    <div class="text-sm text-gray-500 mt-1">Available units: {{ equipment.available_units }}</div>
                </div>
            </div>

            <!-- Rental Form Card -->
            <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8">
                <h3 class="text-2xl font-semibold text-uh-blue-700 mb-6">Rental Details</h3>
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="form-label" for="{{ form.rental_period.id_for_label }}">Rental period</label>
                            {{ form.rental_period }}
                            {% if form.rental_period.errors %}
                                <div class="text-danger small">{{ form.rental_period.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="form-label" for="{{ form.quantity.id_for_label }}">Quantity</label>
                            {{ form.quantity }}
                            {% if form.quantity.errors %}
                                <div class="text-danger small">{{ form.quantity.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="form-label" for="{{ form.start_date.id_for_label }}">Start date</label>
                            {{ form.start_date }}
                            {% if form.start_date.errors %}
                                <div class="text-danger small">{{ form.start_date.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="form-label" for="{{ form.end_date.id_for_label }}">End date</label>
                            {{ form.end_date }}
                            {% if form.end_date.errors %}
                                <div class="text-danger small">{{ form.end_date.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="form-label" for="{{ form.delivery_address.id_for_label }}">Delivery address</label>
                        {{ form.delivery_address }}
                        {% if form.delivery_address.errors %}
                            <div class="text-danger small">{{ form.delivery_address.errors|striptags }}</div>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                        <div>
                            <label class="form-label" for="{{ form.delivery_phone.id_for_label }}">Delivery phone</label>
                            {{ form.delivery_phone }}
                            {% if form.delivery_phone.errors %}
                                <div class="text-danger small">{{ form.delivery_phone.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="form-label" for="{{ form.delivery_instructions.id_for_label }}">Delivery instructions (optional)</label>
                            {{ form.delivery_instructions }}
                        </div>
                    </div>
        
                            <div class="mb-5">
                                <label class="form-label" for="{{ form.customer_notes.id_for_label }}">Notes for owner (optional)</label>
                                {{ form.customer_notes }}
                            </div>
        
                            <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row items-center gap-4">
                                <button type="submit" class="btn btn-primary w-full sm:w-auto py-3 px-6 text-base">Confirm rental</button>
                                <a href="{% url 'equipment:detail' equipment.slug %}" class="btn-link">Back to item</a>
                            </div>
                        </form>
                    </div>
                </div>
        
                <!-- Right Column (Sidebar) -->
                <aside class="lg:col-span-1 sticky top-10">
                    <div class="bg-white rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-semibold text-uh-blue-700 mb-5">Summary</h3>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between text-gray-600">
                                <span>Price per day:</span>
                                <span>रू {{ equipment.price_per_day|floatformat:2 }}</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>Security deposit (per unit):</span>
                                <span>रू {{ equipment.security_deposit|default:0|floatformat:2 }}</span>
                            </div>
                        </div>

                        <hr class="my-4 border-t border-gray-200" />

                        <div class="space-y-3">
                             <div class="flex justify-between text-gray-900 font-semibold">
                                <span>Estimated rental days:</span>
                                <span id="est-days">0</span>
                            </div>
                            <div class="flex justify-between text-gray-900 font-semibold text-lg">
                                <span>Estimated total (rental):</span>
                                <span class="text-uh-green-600">रू <strong id="est-total">0.00</strong></span>
                            </div>
                            <div class="flex justify-between text-gray-900 font-semibold text-lg">
                                <span>Estimated security deposit:</span>
                                <span class="text-uh-green-600">रू <strong id="est-deposit">0.00</strong></span>
                            </div>
                            <p class="text-sm text-gray-500 pt-2">Delivery will be calculated at checkout.</p>
                        </div>
                        
                        <hr classs="my-4 border-t border-gray-200" />
                        
                        <p class="text-xs text-gray-500 mt-5">By confirming you agree to our <a href="#" class="text-uh-blue-700 hover:underline">rental terms & conditions</a>.</p>
                    </div>
                </aside>
            </div>
        </div>
    <!-- End of your original block: content -->

    </div> <!-- End #page-content -->

{% endblock %}

{% block extra_js %}
<script>
(function(){
    const pricePerDay = parseFloat('{{ equipment.price_per_day|floatformat:2 }}') || 0;
    const depositPerUnit = parseFloat('{{ equipment.security_deposit|default:0 }}') || 0;

    const startInput = document.querySelector('input[name="start_date"]');
    const endInput = document.querySelector('input[name="end_date"]');
    const qtyInput = document.querySelector('input[name="quantity"]');

    const estDaysEl = document.getElementById('est-days');
    const estTotalEl = document.getElementById('est-total');
    const estDepositEl = document.getElementById('est-deposit');

    function calc(){
        const start = startInput && startInput.value ? new Date(startInput.value) : null;
        const end = endInput && endInput.value ? new Date(endInput.value) : null;
        const qty = qtyInput ? parseInt(qtyInput.value || '1', 10) : 1;
        
        let days = 0;
        if(start && end && end >= start){
            const diffTime = Math.abs(end - start);
            days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        } else if (start && end && end < start) {
            days = 0;
        }

        const periodSelect = document.querySelector('select[name="rental_period"]');
        if (periodSelect && periodSelect.value) {
            const period = periodSelect.value;
            if (period === 'weekly') {
                if (days === 0 && start) days = 7;
            } else if (period === 'monthly') {
                if (days === 0 && start) days = 30;
            }
        }

        const validQty = (isNaN(qty) || qty < 1) ? 1 : qty;

        if (estDaysEl) estDaysEl.textContent = days;
        const total = (days * pricePerDay * validQty) || 0;
        if (estTotalEl) estTotalEl.textContent = total.toFixed(2);
        if (estDepositEl) estDepositEl.textContent = (depositPerUnit * validQty).toFixed(2);
    }

    [startInput, endInput, qtyInput, document.querySelector('select[name="rental_period"]')].forEach(el => {
        if(!el) return;
        el.addEventListener('change', calc);
    });

    calc();
})();
</script>
{% endblock %}
